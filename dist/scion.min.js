(function(e,t){if(typeof exports==="object"){module.exports=t()}else if(typeof define==="function"&&define.amd){define(t)}else{e.SCION=t()}})(this,function(){"use strict";function t(t){function o(e){if(s[e]===undefined)s[e]=0;var t=s[e]++;return"$generated-"+e+"-"+t}function u(e){return{states:[{type:"initial",transitions:[{target:e}]},e]}}function a(t,s){if(s.transitions)n.push.apply(n,s.transitions);if(s.id){if(r[s.id])throw new Error("Redefinition of state id "+s.id);r[s.id]=s}s.type=s.type||"state";s.ancestors=t;s.depth=t.length;s.parent=t[0];s.transitions=s.transitions||[];s.transitions.forEach(function(e){e.documentOrder=i++;e.source=s});var u=a.bind(null,[s].concat(t));if(s.states)s.states.forEach(u);switch(s.type){case"parallel":s.typeEnum=e.PARALLEL;break;case"initial":s.typeEnum=e.INITIAL;break;case"history":s.typeEnum=e.HISTORY;break;case"final":s.typeEnum=e.FINAL;break;case"state":case"scxml":if(s.states&&s.states.length){s.typeEnum=e.COMPOSITE}else{s.typeEnum=e.BASIC}break;default:throw new Error("Unknown state type: "+s.type)}if(s.states){s.descendants=s.states.concat(s.states.map(function(e){return e.descendants}).reduce(function(e,t){return e.concat(t)},[]))}else{s.descendants=[]}var f;if(s.typeEnum===e.COMPOSITE){if(typeof s.initial==="string"){f=s.states.filter(function(e){return e.id===s.initial});if(f.length){s.initialRef=f[0]}}else{f=s.states.filter(function(e){return e.type==="initial"});s.initialRef=f.length?f[0]:s.states[0]}if(!s.initialRef)throw new Error("Unable to locate initial state for composite state: "+s.id)}if(s.typeEnum===e.COMPOSITE||s.typeEnum===e.PARALLEL){var l=s.states.filter(function(e){return e.type==="history"});s.historyRef=l[0]}if(!s.id){s.id=o(s.type);r[s.id]=s}["onEntry","onExit"].forEach(function(e){if(typeof s[e]==="function"){s[e]=[s[e]]}})}function f(){n.forEach(function(e){if(typeof e.onTransition==="function"){e.onTransition=[e.onTransition]}});n.forEach(function(e){if(e.event){e.events=e.event.trim().split(/ +/)}});n.forEach(function(e){if(e.targets||typeof e.target==="undefined")return;if(typeof e.target==="string"){var t=r[e.target];if(!t)throw new Error("Unable to find target state with id "+e.target);e.target=t;e.targets=[e.target]}else if(Array.isArray(e.target)){e.targets=e.target.map(function(t){if(typeof t==="string"){t=r[t];if(!t)throw new Error("Unable to find target state with id "+e.target);return t}else{return t}})}else if(typeof e.target==="object"){e.targets=[e.target]}else{throw new Error("Transition target has unknown type: "+e.target)}});n.forEach(function(e){if(e.targets)e.lcca=c(e.source,e.targets[0]);e.scope=l(e)})}function l(e){var t=e.type==="internal"&&e.source.parent&&e.targets&&e.targets.every(function(t){return e.source.descendants.indexOf(t)>-1});if(!e.targets){return e.source}else if(t){return e.source}else{return e.lcca}}function c(t,n){var r=[];t.ancestors.forEach(function(t){if(t.typeEnum===e.COMPOSITE&&t.descendants.indexOf(n)>-1){r.push(t)}});if(!r.length)throw new Error("Could not find LCA for states.");return r[0]}var n=[],r={},i=0;var s={};var h=u(t);a([],h);f();return h}function n(e){e=e||[];this.o=[];e.forEach(function(e){this.add(e)},this)}function s(e){var t=e[0],n=e[1];if(t.source.depth<n.source.depth){return n}else if(n.source.depth<t.source.depth){return t}else{if(t.documentOrder<n.documentOrder){return t}else{return n}}}function o(e,t,n){t.x=t.x||{};var r=["x","sessionid","name","ioprocessors"].map(function(e){return t.x["_"+e]=t[e]}).concat(n.isIn.bind(n));return e.apply(n,r)}function a(e,i){this._scriptingContext=i.interpreterScriptingContext||(i.InterpreterScriptingContext?new i.InterpreterScriptingContext(this):{});var u=typeof e==="function"?o(e,i,this):e;this._model=t(u);this.opts=i||{};this.opts.console=i.console||(typeof console==="undefined"?{log:function(){}}:console);this.opts.Set=this.opts.Set||n;this.opts.priorityComparisonFn=this.opts.priorityComparisonFn||s;this.opts.transitionSelector=this.opts.transitionSelector||r;this._scriptingContext.log=this._scriptingContext.log||this.opts.console.log;this._configuration=new this.opts.Set;this._historyValue={};this._internalEventQueue=[];this._isInFinalState=false;this._x={_sessionId:i.sessionId||null,_name:u.name||i.name||null,_ioprocessors:i.ioprocessors||null};this._listeners=[]}function f(e,t){t=t||{};t.InterpreterScriptingContext=t.InterpreterScriptingContext||c;this._isStepping=false;this._externalEventQueue=[];a.call(this,e,t)}function l(e){function t(){}t.prototype=e;return new t}function c(e){this._interpreter=e;this._timeoutMap={}}var e={BASIC:0,COMPOSITE:1,PARALLEL:2,HISTORY:3,INITIAL:4,FINAL:5};n.prototype={add:function(e){if(!this.contains(e))return this.o.push(e)},remove:function(e){var t=this.o.indexOf(e);if(t===-1){return false}else{this.o.splice(t,1)}return true},union:function(e){e=e.iter?e.iter():e;e.forEach(function(e){this.add(e)},this);return this},difference:function(e){e=e.iter?e.iter():e;e.forEach(function(e){this.remove(e)},this);return this},contains:function(e){return this.o.indexOf(e)>-1},iter:function(){return this.o},isEmpty:function(){return!this.o.length},equals:function(e){var t=e.iter();var n=this.o;return n.every(function(e){return t.indexOf(e)>-1})&&t.every(function(e){return n.indexOf(e)>-1})},toString:function(){return"Set("+this.o.toString()+")"}};var r=function(){function t(e){return new RegExp("^"+e.replace(/\./g,"\\.")+"(\\.[0-9a-zA-Z]+)*$")}function n(n){return e[n]?e[n]:e[n]=t(n)}function r(e,t){return t&&t.name&&(e.events.indexOf("*")>-1?true:e.events.filter(function(e){return n(e).test(t.name)}).length)}var e={};return function(e,t,n){return e.transitions.filter(function(e){return(!e.events||r(e,t))&&(!e.cond||n(e.cond))})}}();var i={getAncestors:function(e,t){var n,r,i;r=e.ancestors.indexOf(t);if(r>-1){return e.ancestors.slice(0,r)}else{return e.ancestors}},getAncestorsOrSelf:function(e,t){return[e].concat(this.getAncestors(e,t))},getDescendantsOrSelf:function(e){return[e].concat(e.descendants)},isOrthogonalTo:function(t,n){return!this.isAncestrallyRelatedTo(t,n)&&this.getLCA(t,n).typeEnum===e.PARALLEL},isAncestrallyRelatedTo:function(e,t){return this.getAncestorsOrSelf(t).indexOf(e)>-1||this.getAncestorsOrSelf(e).indexOf(t)>-1},getLCA:function(e,t){var n=this.getAncestors(e).filter(function(e){return e.descendants.indexOf(t)>-1},this);return n[0]}};var u=false;a.prototype={start:function(){if(u)this.opts.console.log("performing initial big step");this._configuration.add(this._model.initialRef);this._performBigStep();return this.getConfiguration()},getConfiguration:function(){return this._configuration.iter().map(function(e){return e.id})},getFullConfiguration:function(){return this._configuration.iter().map(function(e){return[e].concat(i.getAncestors(e))},this).reduce(function(e,t){return e.concat(t)},[]).map(function(e){return e.id}).reduce(function(e,t){return e.indexOf(t)>-1?e:e.concat(t)},[])},isIn:function(e){return this.getFullConfiguration().indexOf(e)>-1},isFinal:function(e){return this._isInFinalState},_performBigStep:function(t){if(t)this._internalEventQueue.push(t);var n=true;while(n){var r=this._internalEventQueue.shift()||null;var i=this._performSmallStep(r);n=!i.isEmpty()}this._isInFinalState=this._configuration.iter().every(function(t){return t.typeEnum===e.FINAL})},_performSmallStep:function(t){if(u)this.opts.console.log("selecting transitions with currentEvent: ",t);var n=this._selectTransitions(t);if(u)this.opts.console.log("selected transitions: ",n);if(!n.isEmpty()){if(u)this.opts.console.log("sorted transitions: ",n);var r=new this.opts.Set(n.iter().filter(function(e){return e.targets}));var i=this._getStatesExited(r),s=i[0],o=i[1];var a=this._getStatesEntered(r),f=a[0],l=a[1];if(u)this.opts.console.log("basicStatesExited ",s);if(u)this.opts.console.log("basicStatesEntered ",f);if(u)this.opts.console.log("statesExited ",o);if(u)this.opts.console.log("statesEntered ",l);var c=new this.opts.Set;if(u)this.opts.console.log("executing state exit actions");var h=this._evaluateAction.bind(this,t);o.forEach(function(t){if(u||this.opts.logStatesEnteredAndExited)this.opts.console.log("exiting ",t.id);this._listeners.forEach(function(e){if(e.onExit)e.onExit(t.id)});if(t.onExit!==undefined)t.onExit.forEach(h);var n;if(t.historyRef){if(t.historyRef.isDeep){n=function(n){return n.typeEnum===e.BASIC&&t.descendants.indexOf(n)>-1}}else{n=function(e){return e.parent===t}}this._historyValue[t.historyRef.id]=o.filter(n)}},this);var p=n.iter().sort(function(e,t){return e.documentOrder-t.documentOrder});if(u)this.opts.console.log("executing transitition actions");p.forEach(function(e){var t=e.targets&&e.targets.map(function(e){return e.id});this._listeners.forEach(function(n){if(n.onTransition)n.onTransition(e.source.id,t)});if(e.onTransition!==undefined)e.onTransition.forEach(h)},this);if(u)this.opts.console.log("executing state enter actions");l.forEach(function(e){if(u||this.opts.logStatesEnteredAndExited)this.opts.console.log("entering",e.id);this._listeners.forEach(function(t){if(t.onEntry)t.onEntry(e.id)});if(e.onEntry!==undefined)e.onEntry.forEach(h)},this);if(u)this.opts.console.log("updating configuration ");if(u)this.opts.console.log("old configuration ",this._configuration);this._configuration.difference(s);this._configuration.union(f);if(u)this.opts.console.log("new configuration ",this._configuration);if(!c.isEmpty()){if(u)this.opts.console.log("adding triggered events to inner queue ",c);this._internalEventQueue.push(c)}}return n},_evaluateAction:function(e,t){return t.call(this._scriptingContext,e)},_getStatesExited:function(e){var t=new this.opts.Set;var n=new this.opts.Set;e.iter().forEach(function(e){var r=e.scope,s=r.descendants;this._configuration.iter().forEach(function(e){if(s.indexOf(e)>-1){n.add(e);t.add(e);i.getAncestors(e,r).forEach(function(e){t.add(e)})}},this)},this);var r=t.iter().sort(function(e,t){return t.depth-e.depth});return[n,r]},_getStatesEntered:function(e){var t={statesToEnter:new this.opts.Set,basicStatesToEnter:new this.opts.Set,statesProcessed:new this.opts.Set,statesToProcess:[]};e.iter().forEach(function(e){e.targets.forEach(function(n){this._addStateAndAncestors(n,e.scope,t)},this)},this);var n;while(n=t.statesToProcess.pop()){this._addStateAndDescendants(n,t)}var r=t.statesToEnter.iter().sort(function(e,t){return e.depth-t.depth});return[t.basicStatesToEnter,r]},_addStateAndAncestors:function(t,n,r){this._addStateAndDescendants(t,r);i.getAncestors(t,n).forEach(function(t){if(t.typeEnum===e.COMPOSITE){r.statesToEnter.add(t);r.statesProcessed.add(t)}else{this._addStateAndDescendants(t,r)}},this)},_addStateAndDescendants:function(t,n){if(n.statesProcessed.contains(t))return;if(t.typeEnum===e.HISTORY){if(t.id in this._historyValue){this._historyValue[t.id].forEach(function(e){this._addStateAndAncestors(e,t.parent,n)},this)}else{n.statesToEnter.add(t);n.basicStatesToEnter.add(t)}}else{n.statesToEnter.add(t);if(t.typeEnum===e.PARALLEL){n.statesToProcess.push.apply(n.statesToProcess,t.states.filter(function(t){return t.typeEnum!==e.HISTORY}))}else if(t.typeEnum===e.COMPOSITE){n.statesToProcess.push(t.initialRef)}else if(t.typeEnum===e.INITIAL||t.typeEnum===e.BASIC||t.typeEnum===e.FINAL){n.basicStatesToEnter.add(t)}}n.statesProcessed.add(t)},_selectTransitions:function(e){if(this.opts.onlySelectFromBasicStates){var t=this._configuration.iter()}else{var n=new this.opts.Set;this._configuration.iter().forEach(function(e){n.add(e);i.getAncestors(e).forEach(function(e){n.add(e)})},this);t=n.iter()}var s=e&&e.name&&e.name.search(".");var o=s?r:this.opts.transitionSelector;var a=new this.opts.Set;var f=this._evaluateAction.bind(this,e);t.forEach(function(t){o(t,e,f).forEach(function(e){a.add(e)})});var l=this._selectPriorityEnabledTransitions(a);if(u)this.opts.console.log("priorityEnabledTransitions",l);return l},_selectPriorityEnabledTransitions:function(e){var t=new this.opts.Set;var n=this._getInconsistentTransitions(e),r=n[0],i=n[1];t.union(r);if(u)this.opts.console.log("enabledTransitions",e);if(u)this.opts.console.log("consistentTransitions",r);if(u)this.opts.console.log("inconsistentTransitionsPairs",i);if(u)this.opts.console.log("priorityEnabledTransitions",t);while(!i.isEmpty()){e=new this.opts.Set(i.iter().map(function(e){return this.opts.priorityComparisonFn(e)},this));n=this._getInconsistentTransitions(e);r=n[0];i=n[1];t.union(r);if(u)this.opts.console.log("enabledTransitions",e);if(u)this.opts.console.log("consistentTransitions",r);if(u)this.opts.console.log("inconsistentTransitionsPairs",i);if(u)this.opts.console.log("priorityEnabledTransitions",t)}return t},_getInconsistentTransitions:function(e){var t=new this.opts.Set;var n=new this.opts.Set;var r=e.iter();if(u)this.opts.console.log("transitions",r);for(var i=0;i<r.length;i++){for(var s=i+1;s<r.length;s++){var o=r[i];var a=r[s];if(this._conflicts(o,a)){t.add(o);t.add(a);n.add([o,a])}}}var f=e.difference(t);return[f,n]},_conflicts:function(e,t){return!this._isArenaOrthogonal(e,t)},_isArenaOrthogonal:function(e,t){if(u)this.opts.console.log("transition scopes",e.scope,t.scope);var n=i.isOrthogonalTo(e.scope,t.scope);if(u)this.opts.console.log("transition scopes are orthogonal?",n);return n},registerListener:function(e){return this._listeners.push(e)},unregisterListener:function(e){return this._listeners.splice(this._listeners.indexOf(e),1)},getAllTransitionEvents:function(){function t(n){if(n.transitions){n.transitions.forEach(function(t){e[t.event]=true})}if(n.states)n.states.forEach(t)}var e={};t(this._model);return Object.keys(e)}};f.prototype=l(a.prototype);f.prototype.gen=function(e,t){var n;switch(typeof e){case"string":n={name:e,data:t};break;case"object":if(typeof e.name==="string"){n=e}else{throw new Error('Event object must have "name" property of type string.')}break;default:throw new Error("First argument to gen must be a string or object.")}this._externalEventQueue.push(n);if(this._isStepping)return null;this._isStepping=true;var r;while(r=this._externalEventQueue.shift()){this._performBigStep(r)}this._isStepping=false;return this.getConfiguration()};c.prototype={raise:function(e){this._interpreter._internalEventQueue.push(e)},send:function(e,t){if(t.delay===undefined){this.gen(e)}else{if(typeof setTimeout==="undefined")throw new Error("Default implementation of Statechart.prototype.send will not work unless setTimeout is defined globally.");if(u)this._interpreter.opts.log("sending event",e.name,"with content",e.data,"after delay",t.delay);var n=setTimeout(this._interpreter.gen.bind(this._interpreter,e),t.delay||0);if(t.sendid)this._timeoutMap[t.sendid]=n}},cancel:function(e){if(typeof clearTimeout==="undefined")throw new Error("Default implementation of Statechart.prototype.cancel will not work unless setTimeout is defined globally.");if(e in this._timeoutMap){if(u)this._interpreter.opts.log("cancelling ",e," with timeout id ",this._timeoutMap[e]);clearTimeout(this._timeoutMap[e])}}};return{BaseInterpreter:a,Statechart:f,ArraySet:n,STATE_TYPES:e,initializeModel:t,InterpreterScriptingContext:c}});var scion=this.SCION
