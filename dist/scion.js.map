{"version":3,"sources":["../lib/scion.js"],"names":["extend","Object","assign","to","from","keys","forEach","k","STATE_TYPES","BASIC","COMPOSITE","PARALLEL","HISTORY","INITIAL","FINAL","ioProcessorTypes","location","transitionWithTargets","t","targets","stateExitComparator","s1","s2","depth","stateEntryComparator","transitionComparator","t1","t2","documentOrder","initializeModel","rootState","transitions","idToStateMap","Map","idCount","generateId","type","undefined","count","wrapInFakeRootState","state","$deserializeDatamodel","$serializeDatamodel","$idToStateMap","states","$type","target","statesWithInitialAttributes","traverse","ancestors","push","apply","id","has","Error","set","length","parent","j","len","transition","source","ancs","concat","typeEnum","descendants","map","s","reduce","a","b","initialChildren","initial","filter","child","initialRef","checkInitialRef","historyChildren","historyRef","onEntry","Array","isArray","onExit","connectIntialAttributes","get","RX_WHITESPACE","connectTransitionGraph","i","onTransition","event","events","trim","split","lcca","getLCCA","scope","getScope","transitionIsReallyInternal","every","indexOf","commonAncestors","anc","fakeRootState","EventEmitter","_listeners","prototype","on","_on","listener","once","_once","self","__once","args","arguments","off","_off","index","splice","emit","_emit","slice","call","modifiedArgs","listeners","ArraySet","l","o","Set","add","x","remove","delete","union","v","difference","contains","iter","isEmpty","size","equals","toString","RX_TRAILING_WILDCARD","isEventPrefixMatch","prefix","fullName","replace","charAt","isTransitionMatch","eventName","some","tEvent","scxmlPrefixTransitionSelector","evaluator","name","cond","query","getAncestors","root","getAncestorsOrSelf","getDescendantsOrSelf","isOrthogonalTo","isAncestrallyRelatedTo","getLCA","getTransitionWithHigherSourceChildPriority","_arg","initializeModelGeneratorFn","modelFn","opts","interpreter","sessionid","ioprocessors","isIn","bind","deserializeSerializedConfiguration","serializedConfiguration","deserializeHistory","serializedHistory","sid","printTrace","BaseInterpreter","modelOrFnGenerator","_scriptingContext","interpreterScriptingContext","InterpreterScriptingContext","model","JSON","parse","_model","console","log","priorityComparisonFn","transitionSelector","join","_internalEventQueue","snapshot","_configuration","_historyValue","_isInFinalState","_x","_sessionId","sessionId","_name","_ioprocessors","beget","start","_performBigStep","getConfiguration","startAsync","cb","nop","_performBigStepAsync","getFullConfiguration","stateName","isFinal","e","keepGoing","currentEvent","shift","selectedTransitions","_performSmallStep","doBigStep","eventToEmit","err","setImmediate","_selectTransitions","selectedTransitionsWithTargets","exitedTuple","_getStatesExited","basicStatesExited","statesExited","enteredTuple","_getStatesEntered","basicStatesEntered","statesEntered","eventsToAddToInnerQueue","stateExited","logStatesEnteredAndExited","exitIdx","exitLen","_evaluateAction","f","isDeep","s0","sortedTransitions","sort","stxIdx","targetIds","txIdx","txLen","enterIdx","enterLen","stateEntered","entryIdx","entryLen","actionRef","tagname","line","column","reason","message","data","transitionList","desc","configList","cfgIdx","cfgLen","ancIdx","ancLen","sortedStatesExited","statesToEnter","basicStatesToEnter","statesProcessed","statesToProcess","targetIdx","targetLen","_addStateAndAncestors","pop","_addStateAndDescendants","sortedStatesEntered","stateFromHistory","onlySelectFromBasicStates","statesAndParents","idx","basicState","enabledTransitions","stateIdx","stateLen","priorityEnabledTransitions","_selectPriorityEnabledTransitions","tuple","_getInconsistentTransitions","consistentTransitions","inconsistentTransitionsPairs","allInconsistentTransitions","_conflicts","_isArenaOrthogonal","isOrthogonal","registerListener","onError","onBigStepBegin","onBigStepSuspend","onBigStepResume","onSmallStepBegin","onSmallStepEnd","onBigStepEnd","unregisterListener","getAllTransitionEvents","getEvents","getSnapshot","_isStepping","_serializeHistory","Statechart","processorType","F","gen","evtObjOrName","optionalData","genAsync","config","_interpreter","_timeoutMap","validateUriRegex","raise","send","options","validateSend","sendAction","targetIsValidUri","test","sendid","eventProcessorTypes","defaultSendAction","setTimeout","timeoutId","delay","publish","scxml","sendFn","customSend","cancel","customCancel","clearTimeout","module","exports"],"mappings":"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","file":"scion.js","sourcesContent":["//   Copyright 2011-2012 Jacob Beard, INFICON, and other SCION contributors\n//\n//   Licensed under the Apache License, Version 2.0 (the \"License\");\n//   you may not use this file except in compliance with the License.\n//   You may obtain a copy of the License at\n//\n//       http://www.apache.org/licenses/LICENSE-2.0\n//\n//   Unless required by applicable law or agreed to in writing, software\n//   distributed under the License is distributed on an \"AS IS\" BASIS,\n//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n//   See the License for the specific language governing permissions and\n//   limitations under the License.\n\n\nvar extend = Object.assign || \n    function (to, from){\n      Object.keys(from).forEach(function(k){\n        to[k] = from[k]; \n      });\n      return to;\n    };\n\nvar STATE_TYPES = {\n    BASIC: 0,\n    COMPOSITE: 1,\n    PARALLEL: 2,\n    HISTORY: 3,\n    INITIAL: 4,\n    FINAL: 5\n};\n\nvar ioProcessorTypes = {\n    'scxml': {\n        location: 'http://www.w3.org/TR/scxml/#SCXMLEventProcessor'\n    },\n    'basichttp': {\n        location: 'http://www.w3.org/TR/scxml/#BasicHTTPEventProcessor'\n    },\n    'dom': {\n        location: 'http://www.w3.org/TR/scxml/#DOMEventProcessor'\n    },\n    'publish': {\n        location: 'https://github.com/jbeard4/SCION#publish'\n    }\n};\n\nfunction transitionWithTargets(t){\n    return t.targets;\n}\n\nfunction stateExitComparator(s1, s2) {\n    return s2.depth - s1.depth;            \n}\n\nfunction stateEntryComparator(s1, s2) {\n    return s1.depth - s2.depth;\n}\n\nfunction transitionComparator(t1, t2) {\n    return t1.documentOrder - t2.documentOrder;\n}\n\nfunction initializeModel(rootState){\n    var transitions = [], idToStateMap = new Map(), documentOrder = 0;\n\n\n    //TODO: need to add fake ids to anyone that doesn't have them\n    //FIXME: make this safer - break into multiple passes\n    var idCount = {};\n\n    function generateId(type){\n        if(idCount[type] === undefined) idCount[type] = 0;\n\n        var count = idCount[type]++;\n        return '$generated-' + type + '-' + count; \n    }\n\n    function wrapInFakeRootState(state){\n        return {\n            $deserializeDatamodel : state.$deserializeDatamodel || function(){},\n            $serializeDatamodel : state.$serializeDatamodel || function(){ return null;},\n            $idToStateMap : idToStateMap,   //keep this for handy deserialization of serialized configuration\n            states : [\n                {\n                    $type : 'initial',\n                    transitions : [{\n                        target : state\n                    }]\n                },\n                state\n            ]\n        };\n    }\n\n    var statesWithInitialAttributes = [];\n\n    function traverse(ancestors,state){\n\n        //add to global transition and state id caches\n        if(state.transitions) transitions.push.apply(transitions,state.transitions);\n\n        //populate state id map\n        if(state.id){\n            if(idToStateMap.has(state.id)) throw new Error('Redefinition of state id ' + state.id);\n\n            idToStateMap.set(state.id, state);\n        }\n\n        //create a default type, just to normalize things\n        //this way we can check for unsupported types below\n        state.$type = state.$type || 'state';\n\n        //add ancestors and depth properties\n        state.ancestors = ancestors;\n        state.depth = ancestors.length;\n        state.parent = ancestors[0];\n\n        //add some information to transitions\n        state.transitions = state.transitions || [];\n        for (var j = 0, len = state.transitions.length; j < len; j++) {\n            var transition = state.transitions[j];\n            transition.documentOrder = documentOrder++; \n            transition.source = state;\n        };\n\n        //recursive step\n        if(state.states) {\n            var ancs = [state].concat(ancestors);\n            for (var j = 0, len = state.states.length; j < len; j++) {\n                traverse(ancs, state.states[j]);\n            }\n        }\n\n        //setup fast state type\n        switch(state.$type){\n            case 'parallel':\n                state.typeEnum = STATE_TYPES.PARALLEL;\n                break;\n            case 'initial' : \n                state.typeEnum = STATE_TYPES.INITIAL;\n                break;\n            case 'history' :\n                state.typeEnum = STATE_TYPES.HISTORY;\n                break;\n            case 'final' : \n                state.typeEnum = STATE_TYPES.FINAL;\n                break;\n            case 'state' : \n            case 'scxml' :\n                if(state.states && state.states.length){\n                    state.typeEnum = STATE_TYPES.COMPOSITE;\n                }else{\n                    state.typeEnum = STATE_TYPES.BASIC;\n                }\n                break;\n            default :\n                throw new Error('Unknown state type: ' + state.$type);\n        }\n\n        //descendants property on states will now be populated. add descendants to this state\n        if(state.states){\n            state.descendants = state.states.concat(state.states.map(function(s){return s.descendants;}).reduce(function(a,b){return a.concat(b);},[]));\n        }else{\n            state.descendants = [];\n        }\n\n        var initialChildren;\n        if(state.typeEnum === STATE_TYPES.COMPOSITE){\n            //set up initial state\n            \n            if(typeof state.initial === 'string'){\n                statesWithInitialAttributes.push(state);\n            }else{\n                //take the first child that has initial type, or first child\n                initialChildren = state.states.filter(function(child){\n                    return child.$type === 'initial';\n                });\n\n                state.initialRef = initialChildren.length ? initialChildren[0] : state.states[0];\n                checkInitialRef(state);\n            }\n\n        }\n\n        //hook up history\n        if(state.typeEnum === STATE_TYPES.COMPOSITE ||\n                state.typeEnum === STATE_TYPES.PARALLEL){\n\n            var historyChildren = state.states.filter(function(s){\n                return s.$type === 'history';\n            }); \n\n           state.historyRef = historyChildren[0];\n        }\n\n        //now it's safe to fill in fake state ids\n        if(!state.id){\n            state.id = generateId(state.$type);\n            idToStateMap.set(state.id, state);\n        }\n\n        //normalize onEntry/onExit, which can be single fn or array\n        if (state.onEntry && !Array.isArray(state.onEntry)) {\n            state.onEntry = [state.onEntry];\n        }\n\n        if (state.onExit && !Array.isArray(state.onExit)) {\n            state.onExit = [state.onExit];\n        }\n    }\n\n    //TODO: convert events to regular expressions in advance\n\n    function checkInitialRef(state){\n      if(!state.initialRef) throw new Error('Unable to locate initial state for composite state: ' + state.id);\n    }\n    function connectIntialAttributes(){\n      for (var j = 0, len = statesWithInitialAttributes.length; j < len; j++) {\n        var s = statesWithInitialAttributes[j];\n        s.initialRef = idToStateMap.get(s.initial);\n        checkInitialRef(s);\n      }\n    }\n\n    var RX_WHITESPACE = /\\s+/;\n\n    function connectTransitionGraph(){\n        //normalize as with onEntry/onExit\n        for (var i = 0, len = transitions.length; i < len; i++) {\n            var t = transitions[i];\n            if (t.onTransition && !Array.isArray(t.onTransition)) {\n                t.onTransition = [t.onTransition];\n            }\n\n            //normalize \"event\" attribute into \"events\" attribute\n            if (typeof t.event === 'string') {\n                t.events = t.event.trim().split(RX_WHITESPACE);\n            }\n            delete t.event;\n\n            if(t.targets || (typeof t.target === 'undefined')) {\n                //targets have already been set up\n                continue;\n            }   \n\n            if(typeof t.target === 'string'){\n                var target = idToStateMap.get(t.target);\n                if(!target) throw new Error('Unable to find target state with id ' + t.target);\n                t.target = target;\n                t.targets = [t.target];\n            }else if(Array.isArray(t.target)){\n                t.targets = t.target.map(function(target){\n                    if(typeof target === 'string'){\n                        target = idToStateMap.get(target);\n                        if(!target) throw new Error('Unable to find target state with id ' + t.target);\n                        return target;\n                    }else{\n                        return target;\n                    } \n                }); \n            }else if(typeof t.target === 'object'){\n                t.targets = [t.target];\n            }else{\n                throw new Error('Transition target has unknown type: ' + t.target);\n            }\n        }\n\n        //hook up LCA - optimization\n        for (var i = 0, len = transitions.length; i < len; i++) {\n            var t = transitions[i];\n            if(t.targets) t.lcca = getLCCA(t.source,t.targets[0]);    //FIXME: we technically do not need to hang onto the lcca. only the scope is used by the algorithm\n\n            t.scope = getScope(t);\n            //console.log('scope',t.source.id,t.scope.id,t.targets);\n        }\n    }\n\n    function getScope(transition){\n        //Transition scope is normally the least common compound ancestor (lcca).\n        //Internal transitions have a scope equal to the source state.\n\n        var transitionIsReallyInternal = \n                transition.type === 'internal' &&\n                    transition.source.parent &&    //root state won't have parent\n                        transition.targets && //does it target its descendants\n                            transition.targets.every(\n                                function(target){ return transition.source.descendants.indexOf(target) > -1;});\n\n        if(!transition.targets){\n            return transition.source; \n        }else if(transitionIsReallyInternal){\n            return transition.source; \n        }else{\n            return transition.lcca;\n        }\n    }\n\n    function getLCCA(s1, s2) {\n        //console.log('getLCCA',s1, s2);\n        var commonAncestors = [];\n        for (var j = 0, len = s1.ancestors.length; j < len; j++) {\n            var anc = s1.ancestors[j];\n            //console.log('s1.id',s1.id,'anc',anc.id,'anc.typeEnum',anc.typeEnum,'s2.id',s2.id);\n            if(anc.typeEnum === STATE_TYPES.COMPOSITE &&\n                anc.descendants.indexOf(s2) > -1){\n                commonAncestors.push(anc);\n            }\n        };\n        //console.log('commonAncestors',s1.id,s2.id,commonAncestors.map(function(s){return s.id;}));\n        if(!commonAncestors.length) throw new Error(\"Could not find LCA for states.\");\n        return commonAncestors[0];\n    }\n\n    //main execution starts here\n    //FIXME: only wrap in root state if it's not a compound state\n    var fakeRootState = wrapInFakeRootState(rootState);  //I wish we had pointer semantics and could make this a C-style \"out argument\". Instead we return him\n    traverse([],fakeRootState);\n    connectTransitionGraph();\n    connectIntialAttributes();\n\n    return fakeRootState;\n}\n\n/* begin tiny-events: https://github.com/ZauberNerd/tiny-events */\nfunction EventEmitter() {\n    this._listeners = {};\n    this._listeners['*'] = [];\n}\n\nEventEmitter.prototype.on = function _on(type, listener) {\n    if (!Array.isArray(this._listeners[type])) {\n        this._listeners[type] = [];\n    }\n\n    if (this._listeners[type].indexOf(listener) === -1) {\n        this._listeners[type].push(listener);\n    }\n\n    return this;\n};\n\nEventEmitter.prototype.once = function _once(type, listener) {\n    var self = this;\n\n    function __once() {\n        for (var args = [], i = 0; i < arguments.length; i += 1) {\n            args[i] = arguments[i];\n        }\n\n        self.off(type, __once);\n        listener.apply(self, args);\n    }\n\n    __once.listener = listener;\n\n    return this.on(type, __once);\n};\n\nEventEmitter.prototype.off = function _off(type, listener) {\n    if (!Array.isArray(this._listeners[type])) {\n        return this;\n    }\n\n    if (typeof listener === 'undefined') {\n        this._listeners[type] = [];\n        return this;\n    }\n\n    var index = this._listeners[type].indexOf(listener);\n\n    if (index === -1) {\n        for (var i = 0; i < this._listeners[type].length; i += 1) {\n            if (this._listeners[type][i].listener === listener) {\n                index = i;\n                break;\n            }\n        }\n    }\n\n    this._listeners[type].splice(index, 1);\n    return this;\n};\n\nEventEmitter.prototype.emit = function _emit(type) {\n\n    var args = Array.prototype.slice.call(arguments);\n    var modifiedArgs = args.slice(1);\n\n    var listeners = this._listeners[type];\n    var j, len;\n    if (Array.isArray(listeners)) {\n      for (j = 0, len = listeners.length; j < len; j++) {\n        listeners[j].apply(this, modifiedArgs);\n      }\n    }\n\n    //special '*' event\n    listeners = this._listeners['*'];\n    for (j = 0, len = listeners.length; j < len; j++) {\n        listeners[j].apply(this, args);\n    }\n\n    return this;\n};\n\n/* end tiny-events */\n\n/* begin ArraySet */\n\n/** @constructor */\nfunction ArraySet(l) {        \n    l = l || [];\n    this.o = new Set(l);        \n}\n\nArraySet.prototype = {\n\n    add : function(x) {\n        this.o.add(x);\n    },\n\n    remove : function(x) {\n        return this.o.delete(x);\n    },\n\n    union : function(l) {\n        for (var v of l.o) {\n            this.o.add(v);\n        }\n        return this;\n    },\n\n    difference : function(l) {\n        for (var v of l.o) {\n            this.o.delete(v);\n        }\n        return this;\n    },\n\n    contains : function(x) {\n        return this.o.has(x);\n    },\n\n    iter : function() {\n        return Array.from(this.o);\n    },\n\n    isEmpty : function() {\n        return !this.o.size;\n    },\n\n    size: function() {\n        return this.o.size;\n    },\n\n    equals : function(s2) {\n        if (this.o.size !== s2.size()) {\n            return false;\n        }\n\n        for (var v of this.o) {\n            if (!s2.contains(v)) {\n                return false;\n            }\n        }\n\n        return true;\n    },\n\n    toString : function() {\n        return \"Set(\" + Array.from(this.o).toString() + \")\";\n    }\n};\n\nconst RX_TRAILING_WILDCARD = /\\.\\*$/;\n\nfunction isEventPrefixMatch(prefix, fullName) {\n    prefix = prefix.replace(RX_TRAILING_WILDCARD, '');\n\n    if (prefix === fullName) {\n        return true;\n    }\n\n    if (prefix.length > fullName.length) {\n        return false;\n    }\n\n    if (fullName.charAt(prefix.length) !== '.') {\n        return false;\n    }\n\n    return (fullName.indexOf(prefix) === 0);\n}\n\nfunction isTransitionMatch(t, eventName) {\n    return t.events.some((tEvent) => {\n        return tEvent === '*' || isEventPrefixMatch(tEvent, eventName);\n    });\n}\n\nfunction scxmlPrefixTransitionSelector(state, event, evaluator) {\n    return state.transitions.filter((t) => {\n        return (!t.events || (event && event.name && isTransitionMatch(t, event.name))) \n          && (!t.cond || evaluator(t.cond));\n    });\n}\n\n//model accessor functions\nvar query = {\n    getAncestors: function(s, root) {\n        var ancestors, index, state;\n        index = s.ancestors.indexOf(root);\n        if (index > -1) {\n            return s.ancestors.slice(0, index);\n        } else {\n            return s.ancestors;\n        }\n    },\n    /** @this {model} */\n    getAncestorsOrSelf: function(s, root) {\n        return [s].concat(this.getAncestors(s, root));\n    },\n    getDescendantsOrSelf: function(s) {\n        return [s].concat(s.descendants);\n    },\n    /** @this {model} */\n    isOrthogonalTo: function(s1, s2) {\n        //Two control states are orthogonal if they are not ancestrally\n        //related, and their smallest, mutual parent is a Concurrent-state.\n        return !this.isAncestrallyRelatedTo(s1, s2) && this.getLCA(s1, s2).typeEnum === STATE_TYPES.PARALLEL;\n    },\n    /** @this {model} */\n    isAncestrallyRelatedTo: function(s1, s2) {\n        //Two control states are ancestrally related if one is child/grandchild of another.\n        return this.getAncestorsOrSelf(s2).indexOf(s1) > -1 || this.getAncestorsOrSelf(s1).indexOf(s2) > -1;\n    },\n    /** @this {model} */\n    getLCA: function(s1, s2) {\n        var commonAncestors = this.getAncestors(s1).filter(function(a){\n            return a.descendants.indexOf(s2) > -1;\n        },this);\n        return commonAncestors[0];\n    }\n};\n\n//priority comparison functions\nfunction getTransitionWithHigherSourceChildPriority(_arg) {\n    var t1 = _arg[0], t2 = _arg[1];\n    //compare transitions based first on depth, then based on document order\n    if (t1.source.depth < t2.source.depth) {\n        return t2;\n    } else if (t2.source.depth < t1.source.depth) {\n        return t1;\n    } else {\n        if (t1.documentOrder < t2.documentOrder) {\n            return t1;\n        } else {\n            return t2;\n        }\n    }\n}\n\nfunction initializeModelGeneratorFn(modelFn, opts, interpreter){\n\n     opts.x =  opts.x || {};\n\n    return modelFn.call(interpreter,\n        opts.x,\n        opts.sessionid,\n        opts.ioprocessors,\n        interpreter.isIn.bind(interpreter));\n}\n\nfunction deserializeSerializedConfiguration(serializedConfiguration,idToStateMap){\n  return serializedConfiguration.map(function(id){\n    var state = idToStateMap.get(id);\n    if(!state) throw new Error('Error loading serialized configuration. Unable to locate state with id ' + id);\n    return state;\n  });\n}\n\nfunction deserializeHistory(serializedHistory,idToStateMap){\n  var o = {};\n  Object.keys(serializedHistory).forEach(function(sid){\n    o[sid] = serializedHistory[sid].map(function(id){\n      var state = idToStateMap.get(id);\n      if(!state) throw new Error('Error loading serialized history. Unable to locate state with id ' + id);\n      return state;\n    });\n  });\n  return o;\n}\n\n/** @const */\nvar printTrace = false;\n\n/** @constructor */\nfunction BaseInterpreter(modelOrFnGenerator, opts){\n\n    EventEmitter.call(this);\n\n    this._scriptingContext = opts.interpreterScriptingContext || (opts.InterpreterScriptingContext ? new opts.InterpreterScriptingContext(this) : {}); \n\n    var model;\n    if(typeof modelOrFnGenerator === 'function'){\n        model = initializeModelGeneratorFn(modelOrFnGenerator, opts, this);\n    }else if(typeof modelOrFnGenerator === 'string'){\n        model = JSON.parse(modelOrFnGenerator);\n    }else{\n        model = modelOrFnGenerator;\n    }\n\n    this._model = initializeModel(model);\n\n    //console.log(require('util').inspect(this._model,false,4));\n   \n    this.opts = opts || {};\n\n    this.opts.console = opts.console || (typeof console === 'undefined' ? {log : function(){}} : console);   //rely on global console if this console is undefined\n    this.opts.Set = this.opts.Set || ArraySet;\n    this.opts.priorityComparisonFn = this.opts.priorityComparisonFn || getTransitionWithHigherSourceChildPriority;\n    this.opts.transitionSelector = this.opts.transitionSelector || scxmlPrefixTransitionSelector;\n\n    this._scriptingContext.log = this._scriptingContext.log || (function log(){ \n      if(this.opts.console.log.apply){\n        this.opts.console.log.apply(this.opts.console, arguments); \n      } else {\n        //console.log on older IE does not support Function.apply, so just pass him the first argument. Best we can do for now.\n        this.opts.console.log(Array.prototype.slice.apply(arguments).join(',')); \n      }\n    }.bind(this));   //set up default scripting context log function\n\n    this._internalEventQueue = [];\n\n    //check if we're loading from a previous snapshot\n    if(opts.snapshot){\n      this._configuration = new this.opts.Set(deserializeSerializedConfiguration(opts.snapshot[0], this._model.$idToStateMap));\n      this._historyValue = deserializeHistory(opts.snapshot[1], this._model.$idToStateMap); \n      this._isInFinalState = opts.snapshot[2];\n      this._model.$deserializeDatamodel(opts.snapshot[3]);   //load up the datamodel\n    }else{\n      this._configuration = new this.opts.Set();\n      this._historyValue = {};\n      this._isInFinalState = false;\n    }\n\n    //SCXML system variables:\n    this._x = {\n        _sessionId : opts.sessionId || null,\n        _name : model.name || opts.name || null,\n        _ioprocessors : opts.ioprocessors || null\n    };\n\n}\n\nBaseInterpreter.prototype = extend(beget(EventEmitter.prototype),{\n\n    /** @expose */\n    start : function() {\n        //perform big step without events to take all default transitions and reach stable initial state\n        if (printTrace) this.opts.console.log(\"performing initial big step\");\n\n        //We effectively need to figure out states to enter here to populate initial config. assuming root is compound state makes this simple.\n        //but if we want it to be parallel, then this becomes more complex. so when initializing the model, we add a 'fake' root state, which\n        //makes the following operation safe.\n        this._configuration.add(this._model.initialRef);   \n\n        this._performBigStep();\n        return this.getConfiguration();\n    },\n\n    /**\n     * Starts the interpreter asynchronously\n     * @param  {Function} cb Callback invoked with an error or the interpreter's stable configuration\n     * @expose\n     */\n    startAsync : function(cb) {\n        if (typeof cb !== 'function') {\n            cb = nop;\n        }\n\n        if (printTrace) this.opts.console.log(\"performing initial big step\");\n\n        this._configuration.add(this._model.initialRef);\n\n        this._performBigStepAsync(null, cb);\n    },\n\n    /** @expose */\n    getConfiguration : function() {\n        return this._configuration.iter().map(function(s){return s.id;});\n    },\n\n    /** @expose */\n    getFullConfiguration : function() {\n        return this._configuration.iter().\n                map(function(s){ return [s].concat(query.getAncestors(s));},this).\n                reduce(function(a,b){return a.concat(b);},[]).    //flatten\n                map(function(s){return s.id;}).\n                reduce(function(a,b){return a.indexOf(b) > -1 ? a : a.concat(b);},[]); //uniq\n    },\n\n\n    /** @expose */\n    isIn : function(stateName) {\n        return this.getFullConfiguration().indexOf(stateName) > -1;\n    },\n\n    /** @expose */\n    isFinal : function(stateName) {\n        return this._isInFinalState;\n    },\n\n    /** @private */\n    _performBigStep : function(e) {\n        this.emit('onBigStepBegin');\n        if (e) this._internalEventQueue.push(e);\n        var keepGoing = true;\n        while (keepGoing) {\n            var currentEvent = this._internalEventQueue.shift() || null;\n            this.emit('onSmallStepBegin', currentEvent);\n            var selectedTransitions = this._performSmallStep(currentEvent);\n            keepGoing = !selectedTransitions.isEmpty();\n        }\n        this._isInFinalState = this._configuration.iter().every(function(s){ return s.typeEnum === STATE_TYPES.FINAL; });\n        this.emit('onBigStepEnd');\n    },\n\n    _performBigStepAsync : function(event, cb) {\n        if (event) {\n            this._internalEventQueue.push(event);\n        }\n\n        var self = this;\n        function doBigStep(eventToEmit) {\n            var selectedTransitions;\n            try {\n                self.emit(eventToEmit);\n                var currentEvent = self._internalEventQueue.shift() || null;\n                self.emit('onSmallStepBegin', currentEvent);\n                selectedTransitions = self._performSmallStep(currentEvent);\n                self.emit('onSmallStepEnd', currentEvent);\n            } catch(err) {\n                cb(err);\n                return;\n            }\n\n            if (!selectedTransitions.isEmpty()) {\n                // keep going, but be nice (yield) to the process\n                // TODO: for compat with non-node, non-mozilla\n                // allow the context to provide the defer task function\n                self.emit('onBigStepSuspend');\n                setImmediate(doBigStep, 'onBigStepResume');\n            } else {\n                self._isInFinalState =\n                    self._configuration.iter().every(function(s) {\n                        return s.typeEnum === STATE_TYPES.FINAL;\n                    });\n                self.emit('onBigStepEnd');\n                cb(undefined, self.getConfiguration());\n            }\n        }\n\n        doBigStep('onBigStepBegin');\n    },\n\n    /** @private */\n    _performSmallStep : function(currentEvent) {\n\n        if (printTrace) this.opts.console.log(\"selecting transitions with currentEvent: \", currentEvent);\n\n        var selectedTransitions = this._selectTransitions(currentEvent);\n\n        if (printTrace) this.opts.console.log(\"selected transitions: \", selectedTransitions);\n\n        if (!selectedTransitions.isEmpty()) {\n\n            if (printTrace) this.opts.console.log(\"sorted transitions: \", selectedTransitions);\n\n            //we only want to enter and exit states from transitions with targets\n            //filter out targetless transitions here - we will only use these to execute transition actions\n            var selectedTransitionsWithTargets = new this.opts.Set(selectedTransitions.iter().filter(transitionWithTargets));\n\n            var exitedTuple = this._getStatesExited(selectedTransitionsWithTargets), \n                basicStatesExited = exitedTuple[0], \n                statesExited = exitedTuple[1];\n\n            var enteredTuple = this._getStatesEntered(selectedTransitionsWithTargets), \n                basicStatesEntered = enteredTuple[0], \n                statesEntered = enteredTuple[1];\n\n            if (printTrace) this.opts.console.log(\"basicStatesExited \", basicStatesExited);\n            if (printTrace) this.opts.console.log(\"basicStatesEntered \", basicStatesEntered);\n            if (printTrace) this.opts.console.log(\"statesExited \", statesExited);\n            if (printTrace) this.opts.console.log(\"statesEntered \", statesEntered);\n\n            var eventsToAddToInnerQueue = new this.opts.Set();\n\n            //update history states\n            if (printTrace) this.opts.console.log(\"executing state exit actions\");\n\n            for (var j = 0, len = statesExited.length; j < len; j++) {\n                var stateExited = statesExited[j];\n\n                if (printTrace || this.opts.logStatesEnteredAndExited) this.opts.console.log(\"exiting \", stateExited.id);\n\n                //invoke listeners\n                this.emit('onExit',stateExited.id)\n\n                if(stateExited.onExit !== undefined) {\n                    for (var exitIdx = 0, exitLen = stateExited.onExit.length; exitIdx < exitLen; exitIdx++) {\n                        this._evaluateAction(currentEvent, stateExited.onExit[exitIdx]);\n                    }\n                }\n\n                var f;\n                if (stateExited.historyRef) {\n                    if (stateExited.historyRef.isDeep) {\n                        f = function(s0) {\n                            return s0.typeEnum === STATE_TYPES.BASIC && stateExited.descendants.indexOf(s0) > -1;\n                        };\n                    } else {\n                        f = function(s0) {\n                            return s0.parent === stateExited;\n                        };\n                    }\n                    //update history\n                    this._historyValue[stateExited.historyRef.id] = statesExited.filter(f);\n                }\n            }\n\n            // -> Concurrency: Number of transitions: Multiple\n            // -> Concurrency: Order of transitions: Explicitly defined\n            var sortedTransitions = selectedTransitions.iter().sort(transitionComparator);\n\n            if (printTrace) this.opts.console.log(\"executing transitition actions\");\n\n\n            for (var stxIdx = 0, len = sortedTransitions.length; stxIdx < len; stxIdx++) {\n                var transition = sortedTransitions[stxIdx];\n\n                var targetIds = transition.targets && transition.targets.map(function(target){return target.id;});\n\n                this.emit('onTransition',transition.source.id,targetIds);\n\n                if(transition.onTransition !== undefined) {\n                    for (var txIdx = 0, txLen = transition.onTransition.length; txIdx < txLen; txIdx++) {\n                        this._evaluateAction(currentEvent, transition.onTransition[txIdx]);\n                    }\n                }\n            }\n \n            if (printTrace) this.opts.console.log(\"executing state enter actions\");\n\n            for (var enterIdx = 0, enterLen = statesEntered.length; enterIdx < enterLen; enterIdx++) {\n                var stateEntered = statesEntered[enterIdx];\n\n                if (printTrace || this.opts.logStatesEnteredAndExited) this.opts.console.log(\"entering\", stateEntered.id);\n\n                this.emit('onEntry',stateEntered.id);\n\n                if(stateEntered.onEntry !== undefined) {\n                    for (var entryIdx = 0, entryLen = stateEntered.onEntry.length; entryIdx < entryLen; entryIdx++) {\n                        this._evaluateAction(currentEvent, stateEntered.onEntry[entryIdx]);\n                    }\n                }\n            }\n\n            if (printTrace) this.opts.console.log(\"updating configuration \");\n            if (printTrace) this.opts.console.log(\"old configuration \", this._configuration);\n\n            //update configuration by removing basic states exited, and adding basic states entered\n            this._configuration.difference(basicStatesExited);\n            this._configuration.union(basicStatesEntered);\n\n\n            if (printTrace) this.opts.console.log(\"new configuration \", this._configuration);\n            \n            //add set of generated events to the innerEventQueue -> Event Lifelines: Next small-step\n            if (!eventsToAddToInnerQueue.isEmpty()) {\n                if (printTrace) this.opts.console.log(\"adding triggered events to inner queue \", eventsToAddToInnerQueue);\n                this._internalEventQueue.push(eventsToAddToInnerQueue);\n            }\n\n        }\n\n        //if selectedTransitions is empty, we have reached a stable state, and the big-step will stop, otherwise will continue -> Maximality: Take-Many\n        return selectedTransitions;\n    },\n\n    /** @private */\n    _evaluateAction : function(currentEvent, actionRef) {\n        try {\n          return actionRef.call(this._scriptingContext, currentEvent);     //SCXML system variables\n        } catch (e){\n          var err = {\n            tagname: actionRef.tagname, \n            line: actionRef.line, \n            column: actionRef.column,\n            reason: e.message\n          }\n          this._internalEventQueue.push({\"name\":\"error.execution\",data : err});\n          this.emit('onError', err);\n        }\n    },\n\n    /** @private */\n    _getStatesExited : function(transitions) {\n        var statesExited = new this.opts.Set();\n        var basicStatesExited = new this.opts.Set();\n\n        //States exited are defined to be active states that are\n        //descendants of the scope of each priority-enabled transition.\n        //Here, we iterate through the transitions, and collect states\n        //that match this condition. \n        var transitionList = transitions.iter();\n        for (var txIdx = 0, txLen = transitionList.length; txIdx < txLen; txIdx++) {\n            var transition = transitionList[txIdx];\n            var scope = transition.scope,\n                desc = scope.descendants;\n\n            //For each state in the configuration\n            //is that state a descendant of the transition scope?\n            //Store ancestors of that state up to but not including the scope.\n            var configList = this._configuration.iter();\n            for (var cfgIdx = 0, cfgLen = configList.length; cfgIdx < cfgLen; cfgIdx++) {\n                var state = configList[cfgIdx];\n                if(desc.indexOf(state) > -1){\n                    basicStatesExited.add(state);\n                    statesExited.add(state);\n                    var ancestors = query.getAncestors(state,scope); \n                    for (var ancIdx = 0, ancLen = ancestors.length; ancIdx < ancLen; ancIdx++) { \n                        statesExited.add(ancestors[ancIdx]);\n                    }\n                }\n            }\n        }\n\n        var sortedStatesExited = statesExited.iter().sort(stateExitComparator);\n        return [basicStatesExited, sortedStatesExited];\n    },\n\n    /** @private */\n    _getStatesEntered : function(transitions) {\n\n        var o = {\n            statesToEnter : new this.opts.Set(),\n            basicStatesToEnter : new this.opts.Set(),\n            statesProcessed  : new this.opts.Set(),\n            statesToProcess : []\n        };\n\n        //do the initial setup\n        var transitionList = transitions.iter();\n        for (var txIdx = 0, txLen = transitionList.length; txIdx < txLen; txIdx++) {\n            var transition = transitionList[txIdx];\n            for (var targetIdx = 0, targetLen = transition.targets.length; targetIdx < targetLen; targetIdx++) {\n                this._addStateAndAncestors(transition.targets[targetIdx],transition.scope,o);\n            }\n        }\n\n        //loop and add states until there are no more to add (we reach a stable state)\n        var s;\n        /*jsl:ignore*/\n        while(s = o.statesToProcess.pop()){\n            /*jsl:end*/\n            this._addStateAndDescendants(s,o);\n        }\n\n        //sort based on depth\n        var sortedStatesEntered = o.statesToEnter.iter().sort(stateEntryComparator);\n\n        return [o.basicStatesToEnter, sortedStatesEntered];\n    },\n\n    /** @private */\n    _addStateAndAncestors : function(target,scope,o){\n\n        //process each target\n        this._addStateAndDescendants(target,o);\n\n        //and process ancestors of targets up to the scope, but according to special rules\n        var ancestors = query.getAncestors(target,scope);\n        for (var ancIdx = 0, ancLen = ancestors.length; ancIdx < ancLen; ancIdx++) {\n            var s = ancestors[ancIdx];\n            if (s.typeEnum === STATE_TYPES.COMPOSITE) {\n                //just add him to statesToEnter, and declare him processed\n                //this is to prevent adding his initial state later on\n                o.statesToEnter.add(s);\n\n                o.statesProcessed.add(s);\n            }else{\n                //everything else can just be passed through as normal\n                this._addStateAndDescendants(s,o);\n            } \n        }\n    },\n\n    /** @private */\n    _addStateAndDescendants : function(s,o){\n\n        if(o.statesProcessed.contains(s)) return;\n\n        if (s.typeEnum === STATE_TYPES.HISTORY) {\n            if (s.id in this._historyValue) {\n                this._historyValue[s.id].forEach(function(stateFromHistory){\n                    this._addStateAndAncestors(stateFromHistory,s.parent,o);\n                },this);\n            } else {\n                o.statesToEnter.add(s);\n                o.basicStatesToEnter.add(s);\n            }\n        } else {\n            o.statesToEnter.add(s);\n\n            if (s.typeEnum === STATE_TYPES.PARALLEL) {\n                o.statesToProcess.push.apply(o.statesToProcess,\n                    s.states.filter(function(s){return s.typeEnum !== STATE_TYPES.HISTORY;}));\n            } else if (s.typeEnum === STATE_TYPES.COMPOSITE) {\n                o.statesToProcess.push(s.initialRef); \n            } else if (s.typeEnum === STATE_TYPES.INITIAL || s.typeEnum === STATE_TYPES.BASIC || s.typeEnum === STATE_TYPES.FINAL) {\n                o.basicStatesToEnter.add(s);\n            }\n        }\n\n        o.statesProcessed.add(s); \n    },\n\n    /** @private */\n    _selectTransitions : function(currentEvent) {\n        if (this.opts.onlySelectFromBasicStates) {\n            var states = this._configuration.iter();\n        } else {\n            var statesAndParents = new this.opts.Set;\n\n            //get full configuration, unordered\n            //this means we may select transitions from parents before states\n            var configList = this._configuration.iter();\n            for (var idx = 0, len = configList.length; idx < len; idx++) {\n                var basicState = configList[idx];\n                statesAndParents.add(basicState);\n                var ancestors = query.getAncestors(basicState);\n                for (var ancIdx = 0, ancLen = ancestors.length; ancIdx < ancLen; ancIdx++) {\n                    statesAndParents.add(ancestors[ancIdx]);\n                }\n            }\n\n            states = statesAndParents.iter();\n        }\n\n        var transitionSelector = this.opts.transitionSelector;\n        var enabledTransitions = new this.opts.Set();\n\n        var e = this._evaluateAction.bind(this,currentEvent);\n\n        for (var stateIdx = 0, stateLen = states.length; stateIdx < stateLen; stateIdx++) {\n            var transitions = transitionSelector(states[stateIdx],currentEvent,e);\n            for (var txIdx = 0, len = transitions.length; txIdx < len; txIdx++) {\n                enabledTransitions.add(transitions[txIdx]);\n            }\n        }\n\n        var priorityEnabledTransitions = this._selectPriorityEnabledTransitions(enabledTransitions);\n\n        if (printTrace) this.opts.console.log(\"priorityEnabledTransitions\", priorityEnabledTransitions);\n        \n        return priorityEnabledTransitions;\n    },\n\n    /** @private */\n    _selectPriorityEnabledTransitions : function(enabledTransitions) {\n        var priorityEnabledTransitions = new this.opts.Set();\n\n        var tuple = this._getInconsistentTransitions(enabledTransitions), \n            consistentTransitions = tuple[0], \n            inconsistentTransitionsPairs = tuple[1];\n\n        priorityEnabledTransitions.union(consistentTransitions);\n\n        if (printTrace) this.opts.console.log(\"enabledTransitions\", enabledTransitions);\n        if (printTrace) this.opts.console.log(\"consistentTransitions\", consistentTransitions);\n        if (printTrace) this.opts.console.log(\"inconsistentTransitionsPairs\", inconsistentTransitionsPairs);\n        if (printTrace) this.opts.console.log(\"priorityEnabledTransitions\", priorityEnabledTransitions);\n        \n        while (!inconsistentTransitionsPairs.isEmpty()) {\n            enabledTransitions = new this.opts.Set(\n                    inconsistentTransitionsPairs.iter().map(function(t){return this.opts.priorityComparisonFn(t);},this));\n\n            tuple = this._getInconsistentTransitions(enabledTransitions);\n            consistentTransitions = tuple[0]; \n            inconsistentTransitionsPairs = tuple[1];\n\n            priorityEnabledTransitions.union(consistentTransitions);\n\n            if (printTrace) this.opts.console.log(\"enabledTransitions\", enabledTransitions);\n            if (printTrace) this.opts.console.log(\"consistentTransitions\", consistentTransitions);\n            if (printTrace) this.opts.console.log(\"inconsistentTransitionsPairs\", inconsistentTransitionsPairs);\n            if (printTrace) this.opts.console.log(\"priorityEnabledTransitions\", priorityEnabledTransitions);\n            \n        }\n        return priorityEnabledTransitions;\n    },\n\n    /** @private */\n    _getInconsistentTransitions : function(transitions) {\n        var allInconsistentTransitions = new this.opts.Set();\n        var inconsistentTransitionsPairs = new this.opts.Set();\n        var transitionList = transitions.iter();\n\n        if (printTrace) this.opts.console.log(\"transitions\", transitionList);\n\n        for(var i = 0; i < transitionList.length; i++){\n            for(var j = i+1; j < transitionList.length; j++){\n                var t1 = transitionList[i];\n                var t2 = transitionList[j];\n                if (this._conflicts(t1, t2)) {\n                    allInconsistentTransitions.add(t1);\n                    allInconsistentTransitions.add(t2);\n                    inconsistentTransitionsPairs.add([t1, t2]);\n                }\n            }\n        }\n\n        var consistentTransitions = transitions.difference(allInconsistentTransitions);\n        return [consistentTransitions, inconsistentTransitionsPairs];\n    },\n\n    /** @private */\n    _conflicts : function(t1, t2) {\n        return !this._isArenaOrthogonal(t1, t2);\n    },\n\n    /** @private */\n    _isArenaOrthogonal : function(t1, t2) {\n\n        if (printTrace) this.opts.console.log(\"transition scopes\", t1.scope, t2.scope);\n\n        var isOrthogonal = query.isOrthogonalTo(t1.scope, t2.scope);\n\n        if (printTrace) this.opts.console.log(\"transition scopes are orthogonal?\", isOrthogonal);\n\n        return isOrthogonal;\n    },\n\n\n    /*\n        registerListener provides a generic mechanism to subscribe to state change and runtime error notifications.\n        Can be used for logging and debugging. For example, can attach a logger that simply logs the state changes.\n        Or can attach a network debugging client that sends state change notifications to a debugging server.\n    \n        listener is of the form:\n        {\n          onEntry : function(stateId){},\n          onExit : function(stateId){},\n          onTransition : function(sourceStateId,targetStatesIds[]){},\n          onError: function(errorInfo){},\n          onBigStepBegin: function(){},\n          onBigStepResume: function(){},\n          onBigStepSuspend: function(){},\n          onBigStepEnd: function(){}\n          onSmallStepBegin: function(event){},\n          onSmallStepEnd: function(){}\n        }\n    */\n    //TODO: refactor this to be event emitter? \n\n    /** @expose */\n    registerListener : function(listener){\n        if(listener.onEntry) this.on('onEntry',listener.onEntry);\n        if(listener.onExit) this.on('onExit',listener.onExit);\n        if(listener.onTransition) this.on('onTransition',listener.onTransition);\n        if(listener.onError) this.on('onError', listener.onError);\n        if(listener.onBigStepBegin) this.on('onBigStepBegin', listener.onBigStepBegin);\n        if(listener.onBigStepSuspend) this.on('onBigStepSuspend', listener.onBigStepSuspend);\n        if(listener.onBigStepResume) this.on('onBigStepResume', listener.onBigStepResume);\n        if(listener.onSmallStepBegin) this.on('onSmallStepBegin', listener.onSmallStepBegin);\n        if(listener.onSmallStepEnd) this.on('onSmallStepEnd', listener.onSmallStepEnd);\n        if(listener.onBigStepEnd) this.on('onBigStepEnd', listener.onBigStepEnd);\n    },\n\n    /** @expose */\n    unregisterListener : function(listener){\n        if(listener.onEntry) this.off('onEntry',listener.onEntry);\n        if(listener.onExit) this.off('onExit',listener.onExit);\n        if(listener.onTransition) this.off('onTransition',listener.onTransition);\n        if(listener.onError) this.off('onError', listener.onError);\n        if(listener.onBigStepBegin) this.off('onBigStepBegin', listener.onBigStepBegin);\n        if(listener.onBigStepSuspend) this.off('onBigStepSuspend', listener.onBigStepSuspend);\n        if(listener.onBigStepResume) this.off('onBigStepResume', listener.onBigStepResume);\n        if(listener.onSmallStepBegin) this.off('onSmallStepBegin', listener.onSmallStepBegin);\n        if(listener.onSmallStepEnd) this.off('onSmallStepEnd', listener.onSmallStepEnd);\n        if(listener.onBigStepEnd) this.off('onBigStepEnd', listener.onBigStepEnd);\n    },\n\n    /** @expose */\n    getAllTransitionEvents : function(){\n        var events = {};\n        function getEvents(state){\n\n            if(state.transitions){\n                for (var txIdx = 0, txLen = state.transitions.length; txIdx < txLen; txIdx++) {\n                    events[state.transitions[txIdx].event] = true;\n                }\n            }\n\n            if(state.states) {\n                for (var stateIdx = 0, stateLen = state.states.length; stateIdx < stateLen; stateIdx++) {\n                    getEvents(state.states[stateIdx]);\n                }\n            }\n        }\n\n        getEvents(this._model);\n\n        return Object.keys(events);\n    },\n\n    \n    /** @expose */\n    /**\n      Three things capture the current snapshot of a running SCION interpreter:\n\n      * basic configuration (the set of basic states the state machine is in)\n      * history state values (the states the state machine was in last time it was in the parent of a history state)\n      * the datamodel\n      \n      Note that this assumes that the method to serialize a scion.SCXML\n      instance is not called when the interpreter is executing a big-step (e.g. after\n      scion.SCXML.prototype.gen is called, and before the call to gen returns). If\n      the serialization method is called during the execution of a big-step, then the\n      inner event queue must also be saved. I do not expect this to be a common\n      requirement however, and therefore I believe it would be better to only support\n      serialization when the interpreter is not executing a big-step.\n    */\n    getSnapshot : function(){\n      if(this._isStepping) throw new Error('getSnapshot cannot be called while interpreter is executing a big-step');\n\n\n      return [\n        this.getConfiguration(),\n        this._serializeHistory(),\n        this._isInFinalState,\n        this._model.$serializeDatamodel()\n      ];\n    },\n\n    _serializeHistory : function(){\n      var o = {};\n      Object.keys(this._historyValue).forEach(function(sid){\n        o[sid] = this._historyValue[sid].map(function(state){return state.id});\n      },this);\n      return o;\n    }\n});\n\n/**\n * @constructor\n * @extends BaseInterpreter\n */\nfunction Statechart(model, opts) {\n    opts = opts || {};\n\n    opts.ioprocessors = {};\n\n    //Create all supported Event I/O processor nodes.\n    //TODO fix location after implementing actual processors\n    for (var processorType in ioProcessorTypes) {\n        opts.ioprocessors[processorType] = ioProcessorTypes[processorType];\n    }\n\n    opts.InterpreterScriptingContext = opts.InterpreterScriptingContext || InterpreterScriptingContext;\n\n    this._isStepping = false;\n\n    BaseInterpreter.call(this,model,opts);     //call super constructor\n}\n\nfunction beget(o){\n    function F(){}\n    F.prototype = o;\n    return new F();\n}\n\n/**\n * Do nothing\n */\nfunction nop() {}\n\n//Statechart.prototype = Object.create(BaseInterpreter.prototype);\n//would like to use Object.create here, but not portable, but it's too complicated to use portably\nStatechart.prototype = beget(BaseInterpreter.prototype);    \n\n/** @expose */\nStatechart.prototype.gen = function(evtObjOrName,optionalData) {\n\n    var currentEvent;\n    switch(typeof evtObjOrName){\n        case 'string':\n            currentEvent = {name : evtObjOrName, data : optionalData};\n            break;\n        case 'object':\n            if(typeof evtObjOrName.name === 'string'){\n                currentEvent = evtObjOrName;\n            }else{\n                throw new Error('Event object must have \"name\" property of type string.');\n            }\n            break;\n        default:\n            throw new Error('First argument to gen must be a string or object.');\n    }\n\n    if(this._isStepping) throw new Error('Cannot call gen during a big-step');\n\n    //otherwise, kick him off\n    this._isStepping = true;\n\n    this._performBigStep(currentEvent);\n\n    this._isStepping = false;\n    return this.getConfiguration();\n};\n\n/**\n * Injects an external event into the interpreter asynchronously\n * @param  {object}   currentEvent The event to inject\n * @param {string} currentEvent.name The name of the event\n * @param {string} [currentEvent.data] The event data\n * @param  {Function} cb Callback invoked with an error or the interpreter's stable configuration\n * @expose\n */\nStatechart.prototype.genAsync = function(currentEvent, cb) {\n    if (typeof currentEvent !== 'object' || !currentEvent || typeof currentEvent.name !== 'string') {\n        throw new Error('expected currentEvent to be an Object with a name');\n    }\n\n    if(this._isStepping) {\n        throw new Error('Cannot call gen during a big-step');\n    }\n\n    if (typeof cb !== 'function') {\n        cb = nop;\n    }\n\n    this._isStepping = true;\n\n    var self = this;\n    this._performBigStepAsync(currentEvent, function(err, config) {\n        self._isStepping = false;\n        cb(err, config);\n    });\n};\n\nfunction InterpreterScriptingContext(interpreter) {\n    this._interpreter = interpreter;\n    this._timeoutMap = {};\n}\n\n//Regex from:\n//  http://daringfireball.net/2010/07/improved_regex_for_matching_urls\n//  http://stackoverflow.com/a/6927878\nvar validateUriRegex = /\\b((?:[a-z][\\w-]+:(?:\\/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}\\/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?]))/i;\n\n//TODO: consider whether this is the API we would like to expose\nInterpreterScriptingContext.prototype = {\n    raise : function(event){\n        this._interpreter._internalEventQueue.push(event); \n    },\n    send : function(event, options){\n        //TODO: move these out\n        function validateSend(event, options, sendAction){\n          if(event.target){\n            var targetIsValidUri = validateUriRegex.test(event.target)\n            if(!targetIsValidUri){\n              return this.raise({ name : \"error.execution\", data: 'Target is not valid URI', sendid: options.sendid });\n            }\n          }\n\n          var eventProcessorTypes = Object.keys(ioProcessorTypes).map(function(k){return ioProcessorTypes[k].location});\n          if(eventProcessorTypes.indexOf(event.type) === -1) {\n              return this.raise({ name : \"error.execution\", data: 'Unsupported event processor type', sendid: options.sendid });\n          }\n\n          sendAction.call(this, event, options);\n        }\n\n        function defaultSendAction (event, options) {\n\n          if( typeof setTimeout === 'undefined' ) throw new Error('Default implementation of Statechart.prototype.send will not work unless setTimeout is defined globally.');\n\n          var timeoutId = setTimeout(this._interpreter.gen.bind(this._interpreter, event), options.delay || 0);\n\n          if (options.sendid) this._timeoutMap[options.sendid] = timeoutId;\n        }\n\n        function publish(){\n          this._interpreter.emit(event.name,event.data);\n        }\n\n        event.type = event.type || ioProcessorTypes.scxml.location;\n\n        //choose send function\n        var sendFn;\n        if(event.type === 'https://github.com/jbeard4/SCION#publish'){\n          sendFn = publish;\n        }else if(this._interpreter.opts.customSend){\n          sendFn = this._interpreter.opts.customSend;\n        }else{\n          sendFn = defaultSendAction;\n        }\n\n        options=options || {};\n\n        if (printTrace) this._interpreter.opts.console.log(\"sending event\", event.name, \"with content\", event.data, \"after delay\", options.delay);\n\n        validateSend.call(this, event, options, sendFn);\n    },\n    cancel : function(sendid){\n        if(this._interpreter.opts.customCancel) {\n            return this._interpreter.opts.customCancel.apply(this, [sendid]);\n        }\n\n        if( typeof clearTimeout === 'undefined' ) throw new Error('Default implementation of Statechart.prototype.cancel will not work unless setTimeout is defined globally.');\n\n        if (sendid in this._timeoutMap) {\n            if (printTrace) this._interpreter.opts.console.log(\"cancelling \", sendid, \" with timeout id \", this._timeoutMap[sendid]);\n            clearTimeout(this._timeoutMap[sendid]);\n        }\n    }\n};\n\nmodule.exports = {\n    /** @expose */\n    BaseInterpreter: BaseInterpreter,\n    /** @expose */\n    Statechart: Statechart,\n    /** @expose */\n    ArraySet : ArraySet,\n    /** @expose */\n    STATE_TYPES : STATE_TYPES,\n    /** @expose */\n    initializeModel : initializeModel,\n    /** @expose */\n    InterpreterScriptingContext : InterpreterScriptingContext,\n    /** @expose */\n    ioProcessorTypes  : ioProcessorTypes \n};\n"]}